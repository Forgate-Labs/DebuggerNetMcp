---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - native/CMakeLists.txt
  - native/src/ptrace_wrapper.c
autonomous: true
requirements:
  - NATIVE-01
  - NATIVE-02

must_haves:
  truths:
    - "cmake --build native/build produces libdotnetdbg.so"
    - "nm -D confirms exactly 5 exported symbols: dbg_attach, dbg_detach, dbg_interrupt, dbg_continue, dbg_wait"
    - "No other symbols are exported (fvisibility=hidden enforced)"
    - "PTRACE_SEIZE is used in dbg_attach (not PTRACE_ATTACH)"
    - "PTRACE_INTERRUPT is used in dbg_interrupt (valid only after PTRACE_SEIZE)"
  artifacts:
    - path: "native/CMakeLists.txt"
      provides: "CMake build definition for shared library"
      contains: "add_library(dotnetdbg SHARED"
    - path: "native/src/ptrace_wrapper.c"
      provides: "C ptrace wrapper with 5 exported functions"
      contains: "PTRACE_SEIZE"
    - path: "native/build/libdotnetdbg.so"
      provides: "Compiled shared library (after cmake build)"
  key_links:
    - from: "native/src/ptrace_wrapper.c"
      to: "native/build/libdotnetdbg.so"
      via: "CMake SHARED library target"
      pattern: "add_library.*SHARED"
---

<objective>
Create the CMake-based native C shared library with PTRACE_SEIZE ptrace wrapper functions.

Purpose: Provides the kernel-safe ptrace interface that the C# debug engine will call in later phases. PTRACE_SEIZE (not PTRACE_ATTACH) is mandated for kernel 6.12+ compatibility.
Output: native/CMakeLists.txt + native/src/ptrace_wrapper.c, verifiable via cmake --build + nm -D.
</objective>

<execution_context>
@/home/eduardo/.claude/get-shit-done/workflows/execute-plan.md
@/home/eduardo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write CMakeLists.txt for libdotnetdbg.so</name>
  <files>
    native/CMakeLists.txt
  </files>
  <action>
    Create `native/CMakeLists.txt` at the repo root's `native/` directory:

    ```cmake
    cmake_minimum_required(VERSION 3.20)
    project(dotnetdbg C)

    add_library(dotnetdbg SHARED src/ptrace_wrapper.c)

    set_target_properties(dotnetdbg PROPERTIES
        OUTPUT_NAME "dotnetdbg"
        C_VISIBILITY_PRESET hidden
        POSITION_INDEPENDENT_CODE ON
    )

    target_compile_options(dotnetdbg PRIVATE -fvisibility=hidden)

    # Output directly to a lib/ directory at repo root for easy discovery by build.sh
    set_target_properties(dotnetdbg PROPERTIES
        LIBRARY_OUTPUT_DIRECTORY "${CMAKE_SOURCE_DIR}/../lib"
    )
    ```

    Key requirements:
    - `cmake_minimum_required(VERSION 3.20)` — matches installed CMake 4.2.1
    - `add_library(dotnetdbg SHARED ...)` — produces libdotnetdbg.so
    - `C_VISIBILITY_PRESET hidden` — hides all symbols by default
    - `-fvisibility=hidden` — compile-level enforcement of hidden visibility
    - `LIBRARY_OUTPUT_DIRECTORY` — outputs libdotnetdbg.so to `lib/` at repo root, avoiding copy step in build.sh
    - Do NOT use `cmake_minimum_required(VERSION 4.0)` — 3.20 is sufficient and more portable

    Create the `native/src/` directory if it doesn't exist before writing the file.
  </action>
  <verify>
    ```bash
    cat /home/eduardo/Projects/DebuggerNetMcp/native/CMakeLists.txt
    # Must show: add_library(dotnetdbg SHARED
    # Must show: C_VISIBILITY_PRESET hidden
    # Must show: LIBRARY_OUTPUT_DIRECTORY
    ```
  </verify>
  <done>
    `native/CMakeLists.txt` exists and contains the SHARED library target with hidden visibility and LIBRARY_OUTPUT_DIRECTORY set to `${CMAKE_SOURCE_DIR}/../lib`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write ptrace_wrapper.c and verify build</name>
  <files>
    native/src/ptrace_wrapper.c
    native/build/ (generated, not committed)
    lib/libdotnetdbg.so (generated, not committed)
  </files>
  <action>
    Create `native/src/ptrace_wrapper.c` with the five required functions. Use PTRACE_SEIZE for attach (NOT PTRACE_ATTACH — the old approach causes SIGSTOP issues on kernel 6.12+):

    ```c
    #include <sys/ptrace.h>
    #include <sys/types.h>
    #include <sys/wait.h>
    #include <errno.h>

    #define EXPORT __attribute__((visibility("default")))

    /*
     * Attach to a running process using PTRACE_SEIZE.
     * PTRACE_SEIZE does NOT stop the process (unlike PTRACE_ATTACH which sends SIGSTOP).
     * Required for kernel 6.12+ compatibility — PTRACE_ATTACH causes race conditions
     * with ICorDebug's libdbgshim callback mechanism.
     */
    EXPORT int dbg_attach(pid_t pid) {
        if (ptrace(PTRACE_SEIZE, pid, NULL, NULL) == -1)
            return -errno;
        return 0;
    }

    /*
     * Detach from a traced process, resuming its execution.
     */
    EXPORT int dbg_detach(pid_t pid) {
        if (ptrace(PTRACE_DETACH, pid, NULL, NULL) == -1)
            return -errno;
        return 0;
    }

    /*
     * Interrupt a running process that was seized with PTRACE_SEIZE.
     * PTRACE_INTERRUPT is only valid after PTRACE_SEIZE; it replaces the old
     * SIGSTOP approach and avoids signal-delivery races.
     */
    EXPORT int dbg_interrupt(pid_t pid) {
        if (ptrace(PTRACE_INTERRUPT, pid, NULL, NULL) == -1)
            return -errno;
        return 0;
    }

    /*
     * Resume a stopped traced process, delivering optional signal sig (0 = no signal).
     */
    EXPORT int dbg_continue(pid_t pid, int sig) {
        if (ptrace(PTRACE_CONT, pid, NULL, (void*)(long)sig) == -1)
            return -errno;
        return 0;
    }

    /*
     * Wait for a traced process to change state.
     * Returns the pid of the child that changed state, or -errno on error.
     */
    EXPORT int dbg_wait(pid_t pid, int *status, int flags) {
        pid_t result = waitpid(pid, status, flags);
        if (result == -1)
            return -errno;
        return (int)result;
    }
    ```

    After writing the file, perform a test build to verify compilation:

    ```bash
    cd /home/eduardo/Projects/DebuggerNetMcp
    mkdir -p lib
    cmake -S native -B native/build -DCMAKE_BUILD_TYPE=Release
    cmake --build native/build --parallel
    ```

    Verify exported symbols:
    ```bash
    nm -D lib/libdotnetdbg.so | grep " T dbg_"
    # Must show 5 lines: dbg_attach, dbg_continue, dbg_detach, dbg_interrupt, dbg_wait
    ```

    Add `native/build/` and `lib/` to `.gitignore` (these are build artifacts, not source):
    ```
    native/build/
    lib/
    ```

    Commit source files only (not the .so or build dir):
    ```bash
    git add native/CMakeLists.txt native/src/ptrace_wrapper.c .gitignore
    git commit -m "feat(01-02): add CMake native ptrace wrapper library (PTRACE_SEIZE)"
    ```
  </action>
  <verify>
    ```bash
    cd /home/eduardo/Projects/DebuggerNetMcp

    # Rebuild from clean state
    cmake -S native -B native/build -DCMAKE_BUILD_TYPE=Release 2>&1 | tail -5
    cmake --build native/build --parallel 2>&1 | tail -5

    # Verify exactly 5 exported symbols
    nm -D lib/libdotnetdbg.so | grep " T dbg_"
    # Expected exactly:
    #   T dbg_attach
    #   T dbg_continue
    #   T dbg_detach
    #   T dbg_interrupt
    #   T dbg_wait

    # Verify PTRACE_SEIZE is used (not PTRACE_ATTACH)
    grep "PTRACE_SEIZE" native/src/ptrace_wrapper.c
    # Must match at least once in dbg_attach

    # Verify no PTRACE_ATTACH usage
    grep "PTRACE_ATTACH" native/src/ptrace_wrapper.c
    # Expected: no output (PTRACE_ATTACH is explicitly forbidden)
    ```
  </verify>
  <done>
    `cmake --build` exits 0. `nm -D lib/libdotnetdbg.so | grep " T dbg_"` shows exactly 5 lines. PTRACE_SEIZE is used in dbg_attach, PTRACE_ATTACH does not appear. Build artifacts are in .gitignore.
  </done>
</task>

</tasks>

<verification>
End-to-end verification for this plan:

```bash
cd /home/eduardo/Projects/DebuggerNetMcp

# Clean build from source
rm -rf native/build lib/
cmake -S native -B native/build -DCMAKE_BUILD_TYPE=Release
cmake --build native/build --parallel

# Verify symbol export
SYMBOLS=$(nm -D lib/libdotnetdbg.so | grep " T dbg_" | awk '{print $3}' | sort)
echo "$SYMBOLS"
# Expected (sorted):
# dbg_attach
# dbg_continue
# dbg_detach
# dbg_interrupt
# dbg_wait

SYMBOL_COUNT=$(echo "$SYMBOLS" | wc -l)
[ "$SYMBOL_COUNT" -eq 5 ] && echo "PASS: 5 symbols exported" || echo "FAIL: expected 5, got $SYMBOL_COUNT"
```
</verification>

<success_criteria>
- `native/CMakeLists.txt` exists with hidden visibility and SHARED library target
- `native/src/ptrace_wrapper.c` implements all 5 functions using PTRACE_SEIZE (not PTRACE_ATTACH)
- `cmake --build native/build` completes without errors
- `nm -D lib/libdotnetdbg.so | grep " T dbg_"` shows exactly 5 exported symbols
- `native/build/` and `lib/` are listed in `.gitignore`
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md` following @/home/eduardo/.claude/get-shit-done/templates/summary.md
</output>
