---
phase: 10-corrija-os-debitos-tecnicos-todos-que-ficaram-em-aberto
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs
  - tests/DebuggerNetMcp.Tests/DebuggerIntegrationTests.cs
  - tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs
autonomous: true
requirements:
  - THRD-03
  - DTEST-02
  - TEST-03
  - TEST-09

must_haves:
  truths:
    - "WaitForSpecificEvent<T> and DrainToExit exist only in DebuggerTestHelpers.cs — not duplicated in the two test classes"
    - "PauseAsync_SuspendsAllThreads_NoEventAfterPause test exists and passes (THRD-03 automated)"
    - "LaunchTestAsync_BreakpointInFact_HitsWithLocals test exists and passes (DTEST-02 automated)"
    - "dotnet test passes all 16+ tests (14 existing + 2 new)"
  artifacts:
    - path: "tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs"
      provides: "Shared WaitForSpecificEvent<T> and DrainToExit helpers"
      contains: "DebuggerTestHelpers"
    - path: "tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs"
      provides: "THRD-03 and DTEST-02 automated tests"
      contains: "PauseAsync_SuspendsAllThreads"
    - path: "tests/DebuggerNetMcp.Tests/DebuggerIntegrationTests.cs"
      provides: "Updated to use DebuggerTestHelpers (no local duplicates)"
  key_links:
    - from: "tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs"
      to: "tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs"
      via: "static method calls DebuggerTestHelpers.WaitForSpecificEvent and DebuggerTestHelpers.DrainToExit"
      pattern: "DebuggerTestHelpers\\."
    - from: "tests/DebuggerNetMcp.Tests/DebuggerIntegrationTests.cs"
      to: "tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs"
      via: "static method calls replacing local duplicates"
      pattern: "DebuggerTestHelpers\\."
---

<objective>
Add 2 missing automated tests (THRD-03 and DTEST-02) and eliminate duplicated test helper code.

Purpose: THRD-03 (debug_pause) and DTEST-02 (debug_launch_test breakpoint) have no automated regression coverage — only manual verification from Phase 7/8. `WaitForSpecificEvent<T>` and `DrainToExit` are copy-pasted in both test classes, creating a maintenance hazard. This plan adds the missing tests and centralizes the helpers.

Output: `DebuggerTestHelpers.cs` (shared helpers), updated integration and advanced test classes (no duplicate helpers), 2 new passing tests.
</objective>

<execution_context>
@/home/eduardo/.claude/get-shit-done/workflows/execute-plan.md
@/home/eduardo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-corrija-os-debitos-tecnicos-todos-que-ficaram-em-aberto/10-RESEARCH.md
@tests/DebuggerNetMcp.Tests/DebuggerFixture.cs
@tests/DebuggerNetMcp.Tests/DebuggerIntegrationTests.cs
@tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs
@tests/DebuggerNetMcp.Tests/MathTests.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared helpers into DebuggerTestHelpers.cs</name>
  <files>
    tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs
    tests/DebuggerNetMcp.Tests/DebuggerIntegrationTests.cs
    tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs
  </files>
  <action>
Read `DebuggerIntegrationTests.cs` and `DebuggerAdvancedTests.cs` in full to identify the exact signatures and bodies of the duplicated helpers. Both files contain identical `WaitForSpecificEvent<T>` and `DrainToExit` static methods.

**Step 1 — Create `tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs`:**

Use the exact method bodies copied from the existing test files. Do not alter the logic. The file should look like:

```csharp
namespace DebuggerNetMcp.Tests;

internal static class DebuggerTestHelpers
{
    public static async Task<T> WaitForSpecificEvent<T>(
        DotnetDebugger dbg, CancellationToken ct) where T : DebugEvent
    {
        // exact body copied from existing test files
    }

    public static async Task DrainToExit(DotnetDebugger dbg, CancellationToken ct)
    {
        // exact body copied from existing test files
    }
}
```

Note: Read the actual implementations from both files first — the DrainToExit in DebuggerAdvancedTests.cs may have a slightly different body (it handles ExceptionEvent with ContinueAsync per Phase 09 decision). The shared helper must include all variants — use the most complete implementation.

**Step 2 — Update `DebuggerIntegrationTests.cs`:**
- Delete the `WaitForSpecificEvent<T>` static method definition from the class body
- Delete the `DrainToExit` static method definition from the class body
- Replace all call sites from `WaitForSpecificEvent<T>(Dbg, cts.Token)` to `DebuggerTestHelpers.WaitForSpecificEvent<T>(Dbg, cts.Token)`
- Replace all call sites from `DrainToExit(Dbg, cts.Token)` to `DebuggerTestHelpers.DrainToExit(Dbg, cts.Token)`

**Step 3 — Update `DebuggerAdvancedTests.cs`:**
- Same as Step 2: delete local definitions, update all call sites with `DebuggerTestHelpers.` prefix
  </action>
  <verify>
Run: `dotnet build tests/DebuggerNetMcp.Tests/ 2>&1 | tail -5` — should compile with no errors
Run: `grep -n "private static.*WaitForSpecificEvent\|private static.*DrainToExit\|static async Task.*WaitForSpecificEvent\|static async Task.*DrainToExit" tests/DebuggerNetMcp.Tests/DebuggerIntegrationTests.cs tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs` — should return NO results (local helpers removed)
Run: `grep -c "WaitForSpecificEvent\|DrainToExit" tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs` — should return 2 (method definitions present)
  </verify>
  <done>DebuggerTestHelpers.cs exists with both helpers. Neither test class contains local helper definitions. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Add THRD-03 and DTEST-02 automated tests</name>
  <files>tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs</files>
  <action>
Add two new [Fact] test methods to `DebuggerAdvancedTests.cs` inside the existing `[Collection("Debugger")]` class.

**Before writing — read `tests/DebuggerNetMcp.Tests/MathTests.cs`** to confirm:
1. The exact line number of `int result = a + b;` (needed for SetBreakpointAsync)
2. The test method name (needed for the filter to prevent recursive spawning)
3. The expected values of `a` and `b`

**THRD-03 Test — PauseAsync_SuspendsAllThreads_NoEventAfterPause:**

```csharp
[Fact]
public async Task PauseAsync_SuspendsAllThreads_NoEventAfterPause()
{
    using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(30));
    await Dbg.LaunchAsync(HelloDebugProject, HelloDebugDll, ct: cts.Token);
    await Dbg.ContinueAsync(cts.Token); // let process run past CreateProcess stop

    await Task.Delay(50, cts.Token);   // give it time to be "running"
    await Dbg.PauseAsync(cts.Token);   // ICorDebug Stop(0) — synchronous suspend all managed threads

    // After pause: process is stopped; inspection APIs must work without errors
    var allThreads = await Dbg.GetAllThreadStackTracesAsync(cts.Token);
    Assert.NotEmpty(allThreads); // at least main thread visible

    // Resume and drain to exit
    await Dbg.ContinueAsync(cts.Token);
    await DebuggerTestHelpers.DrainToExit(Dbg, cts.Token);
    await Dbg.DisconnectAsync(cts.Token);
}
```

**DTEST-02 Test — LaunchTestAsync_BreakpointInFact_HitsWithLocals:**

```csharp
[Fact]
public async Task LaunchTestAsync_BreakpointInFact_HitsWithLocals()
{
    using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(60));

    // The test project is the same project running this test
    // AppContext.BaseDirectory = tests/DebuggerNetMcp.Tests/bin/Debug/net10.0/
    // 4 levels up reaches tests/DebuggerNetMcp.Tests/
    var testProject = Path.GetFullPath(
        Path.Combine(AppContext.BaseDirectory, "..", "..", "..", ".."));

    // The test assembly DLL is already compiled in the test output directory
    var testsDll = Path.Combine(AppContext.BaseDirectory, "DebuggerNetMcp.Tests.dll");

    // Filter: only run AddTwoNumbers_ReturnsCorrectSum — CRITICAL to prevent recursive test spawning
    await Dbg.LaunchTestAsync(testProject, "AddTwoNumbers_ReturnsCorrectSum", cts.Token);

    // Set breakpoint on "int result = a + b;" line — verify exact line by reading MathTests.cs
    await Dbg.SetBreakpointAsync(testsDll, "MathTests.cs", 11, cts.Token);
    await Dbg.ContinueAsync(cts.Token);

    var hit = await DebuggerTestHelpers.WaitForSpecificEvent<BreakpointHitEvent>(Dbg, cts.Token);
    Assert.NotNull(hit);

    var locals = await Dbg.GetLocalsAsync(0, cts.Token);
    var aVar = locals.FirstOrDefault(v => v.Name == "a");
    Assert.NotNull(aVar);
    Assert.Equal("21", aVar.Value);

    await Dbg.ContinueAsync(cts.Token);
    await DebuggerTestHelpers.DrainToExit(Dbg, cts.Token);
    await Dbg.DisconnectAsync(cts.Token);
}
```

**If MathTests.cs has a different line number** for `int result = a + b;` than 11, adjust the `SetBreakpointAsync` call accordingly.

**If DTEST-02 fails with no BreakpointHitEvent** (timeout): the breakpoint line may need adjustment. Use PdbReader to look up the correct ilOffset for that line, or try line 10 or 12. The breakpoint must land on an IL sequence point.

After adding both tests, run each individually:
```bash
dotnet test tests/DebuggerNetMcp.Tests/ --filter "PauseAsync_SuspendsAllThreads" -v normal 2>&1 | tail -20
dotnet test tests/DebuggerNetMcp.Tests/ --filter "LaunchTestAsync_BreakpointInFact" -v normal 2>&1 | tail -30
```

Fix any failures before proceeding to full suite run.
  </action>
  <verify>
Run: `dotnet test tests/DebuggerNetMcp.Tests/ --filter "PauseAsync_SuspendsAllThreads" -v normal 2>&1 | grep -E "Passed|Failed"` — should show 1 Passed
Run: `dotnet test tests/DebuggerNetMcp.Tests/ --filter "LaunchTestAsync_BreakpointInFact" -v normal 2>&1 | grep -E "Passed|Failed"` — should show 1 Passed
Run: `dotnet test tests/DebuggerNetMcp.Tests/ 2>&1 | tail -5` — all tests pass (total count increases by 2 from baseline 14)
  </verify>
  <done>Both new tests pass individually and the full test suite passes. THRD-03 and DTEST-02 now have automated regression coverage.</done>
</task>

</tasks>

<verification>
1. `ls tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs` — file exists
2. `grep -c "WaitForSpecificEvent\|DrainToExit" tests/DebuggerNetMcp.Tests/DebuggerTestHelpers.cs` — returns at least 2
3. `grep "private static\|static async.*WaitForSpecificEvent\|static async.*DrainToExit" tests/DebuggerNetMcp.Tests/DebuggerIntegrationTests.cs tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs` — no results (duplicates removed)
4. `grep "PauseAsync_SuspendsAllThreads\|LaunchTestAsync_BreakpointInFact" tests/DebuggerNetMcp.Tests/DebuggerAdvancedTests.cs` — both test names present
5. `dotnet test tests/DebuggerNetMcp.Tests/ 2>&1 | tail -3` — all tests passed
</verification>

<success_criteria>
- DebuggerTestHelpers.cs exists with WaitForSpecificEvent<T> and DrainToExit as the single source of truth
- No duplicate helper definitions remain in DebuggerIntegrationTests.cs or DebuggerAdvancedTests.cs
- PauseAsync_SuspendsAllThreads_NoEventAfterPause passes (THRD-03 automated)
- LaunchTestAsync_BreakpointInFact_HitsWithLocals passes (DTEST-02 automated)
- Full test suite passes (all tests green, count increases by 2)
</success_criteria>

<output>
After completion, create `.planning/phases/10-corrija-os-debitos-tecnicos-todos-que-ficaram-em-aberto/10-02-SUMMARY.md`
</output>
