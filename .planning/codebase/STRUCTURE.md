# Codebase Structure

**Analysis Date:** 2026-02-22

## Directory Layout

```
DebuggerNetMcp/
├── src/
│   └── debugger_net_mcp/          # Main package (MCP server + DAP client)
│       ├── __init__.py             # Package marker (empty)
│       ├── __main__.py             # Module entry point (calls server.main())
│       ├── server.py               # FastMCP server with 14 debug tools
│       ├── session.py              # DebugSession state machine
│       ├── dap_client.py           # DapClient protocol implementation
│       └── dotnet_utils.py         # Utilities: build, DLL discovery
├── .planning/
│   └── codebase/                   # Analysis documents (generated by mapping tools)
│       ├── ARCHITECTURE.md         # [This document]
│       └── STRUCTURE.md            # [This document]
├── test_*.py                        # Integration and protocol tests (root level)
│   ├── test_integration.py         # Full flow test (launch → step → evaluate → disconnect)
│   ├── test_dap_protocol.py        # DAP message protocol verification
│   ├── test_dap_raw.py             # Raw subprocess communication tests
│   └── test_dap_minimal.py         # Minimal launch test
├── pyproject.toml                  # Package metadata, dependencies, build config
├── uv.lock                          # Lock file for uv (reproducible builds)
├── README.md                        # User docs: features, install, usage
└── LICENSE                          # MIT license
```

## Directory Purposes

**src/debugger_net_mcp/:**
- Purpose: Main MCP server package containing all runtime code
- Contains: Python modules for MCP server, DAP client, session management, utilities
- Key files:
  - `server.py` (206 lines) - Primary entry point
  - `session.py` (571 lines) - Session state machine (largest module)
  - `dap_client.py` (274 lines) - Protocol implementation
  - `dotnet_utils.py` (67 lines) - Build helpers

**Root level (tests):**
- Purpose: Integration and protocol verification tests run from project root
- Contains: Standalone test scripts exercising the MCP server
- Pattern: Each test imports from `src/debugger_net_mcp` and runs async scenarios

**.planning/codebase/:**
- Purpose: Architecture and structure documentation (generated)
- Contains: Analysis documents (ARCHITECTURE.md, STRUCTURE.md, etc.)
- Not committed to git; created by mapping tools

## Key File Locations

**Entry Points:**
- `src/debugger_net_mcp/__main__.py`: Module invocation entry point (`python -m debugger_net_mcp`)
- `src/debugger_net_mcp/server.py`, line 205: `main()` function called by __main__.py

**Configuration:**
- `pyproject.toml`: Python package metadata, dependencies (mcp>=1.2.0), build settings
- No .env files (uses environment variables: DOTNET_ROOT, NETCOREDBG_PATH, LD_LIBRARY_PATH)

**Core Logic:**
- `src/debugger_net_mcp/server.py`: 14 MCP tool handlers (@mcp.tool() decorated async functions)
- `src/debugger_net_mcp/session.py`: DebugSession state machine and lifecycle management
- `src/debugger_net_mcp/dap_client.py`: DapClient protocol bridge to netcoredbg

**Testing:**
- `test_integration.py`: Full debug flow test (14 assertions on launch→step→evaluate→disconnect)
- `test_dap_protocol.py`: DAP message protocol verification
- `test_dap_raw.py`: Raw subprocess I/O tests
- `test_dap_minimal.py`: Minimal launch test

## Naming Conventions

**Files:**
- Module files: `lowercase_with_underscores.py` (e.g., `dap_client.py`, `dotnet_utils.py`)
- Test files: `test_*.py` (e.g., `test_integration.py`)
- No hyphens in filenames except in package name `debugger-net-mcp` (pyproject.toml)

**Directories:**
- Package: `debugger_net_mcp` (underscores, lowercase)
- Source root: `src/` (convention for pip-installable packages)
- Planning docs: `.planning/codebase/` (hidden dot directory for generated docs)

**Functions:**
- Session methods: `snake_case_with_underscores` (e.g., `launch()`, `set_breakpoint()`, `continue_execution()`)
- Private methods: leading `_` (e.g., `_require_state()`, `_handle_stopped_event()`, `_wait_for_stop()`)
- Async functions: same naming, prefixed with `async def`
- Tool handlers: `debug_<action>` (e.g., `debug_launch`, `debug_step_over`)

**Classes:**
- `PascalCase` (e.g., `DebugSession`, `DapClient`, `SessionState`)

**Constants:**
- `UPPERCASE_WITH_UNDERSCORES` (e.g., `MAX_OUTPUT_LINES`, `_NETCOREDBG_SEARCH_PATHS`)

## Where to Add New Code

**New Debug Tool (e.g., debug_restart):**
- Add async function to `src/debugger_net_mcp/server.py` decorated with `@mcp.tool()`
- Function signature: `async def debug_<name>(arg1: str, ...) -> dict`
- Implementation: call session method, return `{"success": bool, ...}` dict
- Tests: add assertions to `test_integration.py`

**New Session Operation (e.g., conditional breakpoint, logpoint):**
- Add async method to `DebugSession` class in `src/debugger_net_mcp/session.py`
- Private helpers: use `_` prefix (e.g., `_handle_<event>()`, `_send_<request>()`)
- Use existing patterns:
  - State checks: call `self._require_state(SessionState.X, ...)`
  - DAP requests: call `await self._dap.send_request("command", {...})`
  - Event waits: call `await self._dap.wait_for_event("event_name", timeout=...)`
- Return dict with at minimum `{"success": bool}`

**New DAP Protocol Handling (e.g., exception details, module events):**
- Add event queue entry to `DapClient._dispatch()` method (line 272–276 in `dap_client.py`)
- Incoming messages of type "event" with matching name enqueued to `_event_queues[event_name]`
- Existing pattern: `"stopped"`, `"output"`, `"terminated"`, `"exited"` events already handled

**Utilities (e.g., project discovery, runtime resolution):**
- Add functions to `src/debugger_net_mcp/dotnet_utils.py`
- Public functions: `async def function_name(...) -> ReturnType`
- Private helpers: `_function_name(...)`
- Return tuple `(output_text, result_or_none)` for operations that build/execute

## Special Directories

**src/debugger_net_mcp/__pycache__/:**
- Purpose: Python bytecode cache
- Generated: Yes (by Python interpreter)
- Committed: No (listed in .gitignore)

**.venv/:**
- Purpose: Virtual environment for development
- Generated: Yes (by `uv sync` or `python -m venv`)
- Committed: No (listed in .gitignore)

**.git/:**
- Purpose: Git repository metadata
- Generated: Yes (by `git init`)
- Committed: Yes (git internals)

**.planning/:**
- Purpose: Planning and analysis documents
- Generated: Yes (by mapping tools)
- Committed: No (architecture docs generated on-demand)

## Dependency Organization

**External Dependencies:**
- `mcp[cli]>=1.2.0`: FastMCP server framework and CLI tools (only external dependency)

**Standard Library:**
- `asyncio`: Async subprocess and event coordination
- `json`: DAP message serialization
- `logging`: Diagnostic logging
- `os`, `shutil`, `pathlib`: File/path operations
- `re`: Regex for DLL path extraction from build output
- `platform`: Kernel version detection (for strace workaround)
- `enum`: SessionState enum
- `collections`: deque for output buffering
- `typing`: Type hints

## Module Dependencies

```
server.py
  ├─ imports: FastMCP, session.get_session
  └─ no other local imports (tools call session methods)

session.py
  ├─ imports: DapClient, dotnet_build
  ├─ exports: DebugSession, SessionState, get_session()
  └─ uses: dap_client module, dotnet_utils module

dap_client.py
  ├─ imports: asyncio, json, os, shutil, pathlib, logging, platform
  ├─ exports: DapClient class
  └─ no local imports (pure protocol implementation)

dotnet_utils.py
  ├─ imports: asyncio, re, pathlib
  ├─ exports: dotnet_build() function
  └─ no local imports (independent utility)

__main__.py
  └─ imports: server.main
```

## Code Organization Principles

1. **Separation of Concerns:**
   - MCP server (tools) in `server.py`
   - Session state machine in `session.py`
   - Protocol details in `dap_client.py`
   - Build utilities in `dotnet_utils.py`

2. **Asyncio-First:**
   - All potentially blocking operations are async
   - Subprocess creation and I/O use `asyncio` APIs
   - Event coordination via `asyncio.Queue` and `asyncio.Event`

3. **State Encapsulation:**
   - Session state private to `DebugSession` class (underscore-prefixed attributes)
   - State transitions validated by `_require_state()`
   - DAP state isolated in `DapClient` (hidden from session)

4. **Event-Driven:**
   - Background tasks monitor incoming events (`_reader_loop`, `_listen_outputs`)
   - Waiters dequeue from event-specific queues
   - No polling or synchronous blocking

5. **Error Handling:**
   - Tools return dicts with status info (not raising exceptions to Claude)
   - Internal exceptions logged and converted to error dicts
   - Cleanup always runs (try/finally patterns)

---

*Structure analysis: 2026-02-22*
